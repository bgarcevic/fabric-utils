parameters:
  - name: deployments
    type: object
    default:
      - workspace_name: 'data_workspace1'
        repository_directory: './fabric-workspaces/data_workspace1/'
      - workspace_name: 'report_workspace2'
        repository_directory: './fabric-workspaces/report_workspace2/'
      - workspace_name: 'report_workspace3'
        repository_directory: './fabric-workspaces/report_workspace3/'

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - fabric-workspaces/*
    exclude:
    - fabric-workspaces/archive/*

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Staging
    displayName: 'Deploy to Staging'
    jobs:
      - job: staging_deploy_duos
        displayName: 'Staging Deployment Job - Staging DUOS Analytics Data'
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - script: |
              curl -LsSf https://astral.sh/uv/install.sh | sh
              echo "##vso[task.prependpath]$HOME/.cargo/bin"
            displayName: 'Install uv'

          - script: |
              echo "============================================"
              echo "STAGING DEPLOYMENT"
              echo "Branch: main"
              echo "Environment: STG"
              echo "============================================"

              # For staging, always use 'main' branch
              TAG_NAME="main"

              echo "##vso[task.setvariable variable=GIT_TAG]$TAG_NAME"
              echo "Git reference: $TAG_NAME"
            displayName: 'Set Git Reference to Main'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'BI-fabric-deployment'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                uv run ./.devops/deploy-fabric-resources.py --workspace_name 'Staging DUOS Analytics Data' --environment STG --repository_directory './fabric-workspaces/duos-analytics-data/'
            displayName: 'Deploy to Staging Environment - Staging DUOS Analytics Data'
            env:
              $ENV:STG_GIT_TAG: $(GIT_TAG)

          - script: |
              echo "============================================"
              echo "✅ STAGING DEPLOYMENT COMPLETE - Staging DUOS Analytics Data"
              echo "Environment: STG"
              echo "Git Reference: $(GIT_TAG)"
              echo "============================================"
            displayName: 'Deployment Summary - Staging DUOS Analytics Data'

      - ${{ each deployment in parameters.deployments }}:
          - job: staging_deploy_${{ replace(deployment.workspace_name, ' ', '_') }}
            dependsOn: staging_deploy_duos
            displayName: 'Staging Deployment Job - ${{ deployment.workspace_name }}'
            steps:
              - checkout: self
                displayName: 'Checkout repository'

              - script: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo "##vso[task.prependpath]$HOME/.cargo/bin"
                displayName: 'Install uv'

              - script: |
                  echo "============================================"
                  echo "STAGING DEPLOYMENT"
                  echo "Branch: main"
                  echo "Environment: STG"
                  echo "============================================"

                  # For staging, always use 'main' branch
                  TAG_NAME="main"

                  echo "##vso[task.setvariable variable=GIT_TAG]$TAG_NAME"
                  echo "Git reference: $TAG_NAME"
                displayName: 'Set Git Reference to Main'

              - task: AzureCLI@2
                inputs:
                  azureSubscription: 'BI-fabric-deployment'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  inlineScript: |
                    uv run ./.devops/deploy-fabric-resources.py --workspace_name '${{ deployment.workspace_name }}' --environment STG --repository_directory '${{ deployment.repository_directory }}'
                displayName: 'Deploy to Staging Environment - ${{ deployment.workspace_name }}'
                env:
                  $ENV:STG_GIT_TAG: $(GIT_TAG)

              - script: |
                  echo "============================================"
                  echo "✅ STAGING DEPLOYMENT COMPLETE - ${{ deployment.workspace_name }}"
                  echo "Environment: STG"
                  echo "Git Reference: $(GIT_TAG)"
                  echo "============================================"
                displayName: 'Deployment Summary - ${{ deployment.workspace_name }}'